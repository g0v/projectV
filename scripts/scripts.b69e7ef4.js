"use strict";angular.module("projectVApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","leaflet-directive","ui.bootstrap","facebook","firebase","angulartics","angulartics.google.analytics"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/news",{templateUrl:"views/news.html",controller:"NewsCtrl"}).when("/plan",{templateUrl:"views/plan.html"}).when("/demo",{templateUrl:"views/demo.html"}).when("/petition",{templateUrl:"views/petition.html",controller:"PetitionCtrl"}).when("/mission/:county",{templateUrl:"views/mission.html",controller:"MissionCtrl"}).when("/mroute/:county",{templateUrl:"views/blank.html",controller:"MrouteCtrl"}).when("/map/:county",{templateUrl:"views/map.html",controller:"MapCtrl"}).when("/minimap/:county",{templateUrl:"views/minimap.html",controller:"MapCtrl"}).when("/aftermap/:county",{templateUrl:"views/aftermap.html",controller:"AftermapCtrl"}).when("/faq",{templateUrl:"views/faq.html",controller:"FaqCtrl"}).when("/mobile",{templateUrl:"views/mobile.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]).config(["FacebookProvider",function(a){var b="500181739999677";a.init(b)}]).filter("percentage",["$filter",function(a){return function(b,c){return a("number")(100*b,c)+"%"}}]).filter("newlines",function(){return function(a){return a.split(/\n/g)}}),angular.module("projectVApp").controller("MainCtrl",["$scope","Countdown","FINALDATE","$interval","$anchorScroll","addparserservice",function(a,b,c,d,e){e(),a.time=b.getTime(new Date(c),new Date),d(function(){a.time=b.getTime(new Date(c),new Date)},1e3)}]),angular.module("projectVApp").controller("PetitionCtrl",["$scope",function(){}]),angular.module("projectVApp").controller("MissionsCtrl",["$scope","Countdown","$modal","FINALDATE_DISTRICTS",function(a,b,c,d){a.missions=[{id:"TPE-4",name:"TPE-4",finalDate:b.getTime(new Date(d.TPE4),new Date)},{id:"TPQ-1",name:"TPQ-1",finalDate:b.getTime(new Date(d.TPQ1),new Date)},{id:"TPQ-6",name:"TPQ-6",finalDate:b.getTime(new Date(d.TPQ6),new Date)}];var e;a.registerDialog=function(a){e=c.open({templateUrl:"views/closereg.html",controller:"registerCloseController",size:"md",resolve:{data:function(){return{county:"Taiwan",type:a}}}})}}]),angular.module("projectVApp").controller("PagesCtrl",["$scope","$location",function(a,b){-1==b.url().indexOf("minimap")&&(a.showNav=!0,a.pages=[{id:"news",name:"戰略消息",img:"https://s3-ap-southeast-1.amazonaws.com/1129vday.tw/img/1129-03.svg","class":"nav-title",cssid:"nav2"},{id:"petition",name:"連署書資訊",img:"https://s3-ap-southeast-1.amazonaws.com/1129vday.tw/img/1129-09.svg","class":"nav-title",cssid:"nav5"},{id:"plan",name:"連署書代收點",img:"https://s3-ap-southeast-1.amazonaws.com/1129vday.tw/img/1129-05.svg","class":"nav-title",cssid:"nav3"},{id:"demo",name:"自由罷免示範區",img:"https://s3-ap-southeast-1.amazonaws.com/1129vday.tw/img/1129-07.svg","class":"nav-title",cssid:"nav4"},{id:"faq",name:"FAQ"},{name:"贊助我們",href:"http://tshirt.appy.tw/",target:"_blank"}],a.getActive=function(a){return b.url().substr(1)===a?"active":""},a.getHref=function(a){return a.href?a.href:"#/"+a.id},a.getTarget=function(a){return a.target?a.target:"_self"})}]);var DEFAULT_COUNTY="TPE-4",MAP_RELOAD_TIME=1e4,MAP_DEFAULT_BOUND={"TPE-4":[{lat:25.1151655,lng:121.6659156},{lat:25.0122295,lng:121.5521896}],"TPQ-1":[{lat:25.301133,lng:121.6195265},{lat:25.0287778,lng:121.2826487}],"TPQ-6":[{lat:25.0398178,lng:121.4895901},{lat:25.0034634,lng:121.4451953}]},MAP_MIN_ZOOM={"TPE-4":13,"TPQ-1":11,"TPQ-6":14};angular.module("projectVApp").controller("MapCtrl",["$scope","$route","$routeParams","$http","$q","$filter","$modal","$window","$location","leafletData","voteInfoService",function(a,b,c,d,e,f,g,h,i,j,k){function l(){m(D)}function m(b){var c=b[0];return a.myscope.mapLoadingStatus=.2+(D.length-b.length)/D.length*.8,c?void(a.geojson?a.leafletData.getGeoJSON().then(function(a){a.addData(c),setTimeout(function(){m(b.slice(1))},k.MAP_BUFFER_TIME)}):(a.geojson={data:c,style:n,resetStyleOnMouseout:!1},setTimeout(function(){m(b.slice(1))},k.MAP_BUFFER_TIME))):(a.myscope.mapLoadingStatus=1,$(".myLoading").fadeOut("slow",function(){$(".myLoading").remove(),"TPE-4"!=z&&$("#mroute-TPE-4").css({visibility:"visible"}),"TPQ-6"!=z&&$("#mroute-TPQ-6").css({visibility:"visible"}),"TPQ-1"!=z&&$("#mroute-TPQ-1").css({visibility:"visible"})}),void(a.myscope.mapLoadingComplete=!0))}function n(a){return{opacity:1,weight:2,color:"black",dashArray:"6",fillOpacity:.5,fillColor:a.properties.mycolor,className:"county transparent"}}function o(a){var b=a.feature.properties.mycolor;return{fillColor:b}}function p(){return{weight:2,color:"black",dashArray:"6"}}function q(){return{weight:6,color:"yellow",dashArray:"0"}}function r(a,b){var c=b.target;c!=A&&(c.setStyle(I),c.bringToFront(),A&&A.bringToFront())}function s(a,b){var c=b.target;c!=A&&(c.setStyle(J),c.bringToFront(),A&&A.bringToFront())}function t(b,c,d){a.$emit("dataReload");var e=d.target.feature.properties.town,f=d.target.feature.properties.village,g=d.target;u(e,f,g),v(e,f,0)}function u(a,b,c){A&&A.setStyle(p()),c.setStyle(q()),c.bringToFront(),A=c}function v(b,c,d){a.myscope.showVS={},a.myscope.showVS.townName=b,a.myscope.showVS.villageName=c,a.myscope.showVS.vsArray=[],a.markers={};var e=[],f=0;angular.forEach(a.myscope.voteStatData[b],function(g){var h=g.neighborhood.indexOf(c);-1!=h&&(a.myscope.showVS.vsArray.push({name:g.name,id:g.id}),e.length==d&&(f=g.id),e.push({vsid:g.id,townName:b,villageName:c,vspos:e.length,vscount:H(.5*(a.myscope.vsInfo[g.id].volunteer+a.myscope.vsInfo[g.id].supplement)),vsobj:{lat:g.location.lat,lng:g.location.lng}}))}),e.length>0&&(x(e),a.myscope.setCurrentMarkerClick(f,!1,!1)),a.leafletData.getMap().then(function(a){var b=[];if(A){var c=A.getBounds();b.push({lat:c._northEast.lat,lng:c._northEast.lng}),b.push({lat:c._southWest.lat,lng:c._southWest.lng})}for(var d=0;d<e.length;d++)b.push({lat:e[d].vsobj.lat,lng:e[d].vsobj.lng});b.length>0&&a.fitBounds(b)})}function w(b){a.myscope.currentVsTab.vsId=b,a.myscope.currentVsTab.vsName=function(){for(var c=0;c<a.myscope.showVS.vsArray.length;c++){var d=a.myscope.showVS.vsArray[c];if(d.id==b)return d.name}}()}function x(b){var c={};B=null,angular.forEach(b,function(a){var b=a.vscount;c[a.vsid]={draggable:!1,lat:a.vsobj.lat,lng:a.vsobj.lng,icon:F[b].x,myicons:F[b],mycount:b,mypos:a.vspos,myloc:a.townName+"-"+a.villageName,myid:a.vsid}}),angular.extend(a,{markers:c}),a.$on("leafletDirectiveMarker.click",function(b,c){a.myscope.setCurrentMarkerClick(c.markerName,!1,!0)}),a.$on("leafletDirectiveMarker.mouseover",function(b,c){var d=a.markers[c.markerName];d.icon=d.myicons.d}),a.$on("leafletDirectiveMarker.mouseout",function(b,c){var d=(c.markerName,a.markers[c.markerName]);d.icon=d!=B?d.myicons.x:d.myicons.c})}function y(b){k.resetDynamics(z),b&&k.getStaticVillageData(z).then(function(a){(a.county=z)&&l()},function(){},function(b){(b.county=z)&&(a.myscope.mapLoadingStatus=.2*b.loadingStatus,jQuery.isEmptyObject(b.villageArea)||(b.villageArea.features[0].properties.mycolor=G(b.villageSum),D.push(b.villageArea)))}),e.all([k.getAllVoteStatInfo(z),k.getAllVoteStatData(z),k.getAllVillageSum(z)]).then(function(c){a.myscope.vsInfo=c[0],a.myscope.voteStatData=c[1],a.myscope.villageSum=c[2],b?(a.myscope.villList=Object.keys(a.myscope.villageSum),a.myscope.currentTownTab=a.myscope.villList[0]):(a.myscope.showVS&&v(a.myscope.showVS.townName,a.myscope.showVS.villageName,C),a.leafletData.getGeoJSON().then(function(b){var c=b.getLayers();angular.forEach(c,function(b){var c=b.feature.properties.town,d=b.feature.properties.village;b.feature.properties.mycolor=G(a.myscope.villageSum[c][d]),b.setStyle(o(b)),A&&A.setStyle(q())})}))})}a.myscope={},a.myscope.mapLoadingComplete=!1,a.myscope.mapLoadingStatus=!1;var z=c.county,A=null,B=null,C=0,D=[],E=(new Date).getTime();a.myscope.county=z,a.myscope.voteStatData=null,a.myscope.showVS=null,a.myscope.currentVsTab={},a.myscope.currentTownTab="",a.myscope.vsInfo={},a.myscope.supplementItem=k.supplementItem,a.myscope.volCount=k.volCount,a.myscope.villList=[],a.myscope.spPeopleMore=!1,a.myscope.hpPeopleMore=!1,a.myscope.spPeopleClick=function(){a.myscope.spPeopleMore=!a.myscope.spPeopleMore},a.myscope.hpPeopleClick=function(){a.myscope.hpPeopleMore=!a.myscope.hpPeopleMore},a.leafletData=j;var F=function(){var a=[60,100],b=[30,10],c=[a[0]/2,a[1]],d=[b[0]/2,b[1]/2],e=["1","2","3"],f=["x","c","d"],g={};return angular.forEach(e,function(e){g[e]={},angular.forEach(f,function(f){g[e][f]={iconSize:a,iconAnchor:c,iconUrl:"images/map"+f+e+".svg",shadowSize:b,shadowAnchor:d,shadowUrl:"images/map_icon_shadow.svg"}})}),g}();z in MAP_DEFAULT_BOUND||(z=DEFAULT_COUNTY);var G=function(a){return null==a?"#333333":a>=1?"#990000":a>.5?"#993333":a>0?"#aa6666":"#aaaaaa"},H=function(a){return a>.66?3:a>.33?2:1};a.myscope.getVoteStatImg=function(){return a.myscope.showVS?0==a.myscope.showVS.vsArray.length?3:a.myscope.showVS?H(.5*(a.myscope.vsInfo[a.myscope.currentVsTab.vsId].volunteer+a.myscope.vsInfo[a.myscope.currentVsTab.vsId].supplement)):1:1};var I={weight:6,color:"white"},J={weight:2,color:"black"};a.myscope.setCurrentAreaClick=function(b,c){a.$emit("dataReload"),a.leafletData.getGeoJSON().then(function(a){var d=a.getLayers();angular.forEach(d,function(a){var d=a.feature.properties.town,e=a.feature.properties.village;b==d&&c==e&&u(b,c,a)})}),v(b,c,0)},a.myscope.setCurrentMarkerClick=function(b,c){a.myscope.spPeopleMore=!1,a.myscope.hpPeopleMore=!1;var d=a.markers[b];C=d.mypos,w(b),B&&(B.icon=B.myicons.x),d.icon=d.myicons.c,B=d,c&&a.leafletData.getMap().then(function(a){a.setView({lat:d.lat,lng:d.lng})})},a.myscope.setTownTab=function(b){a.myscope.currentTownTab=b},a.myscope.isCurrentTownTab=function(b){return a.myscope.currentTownTab==b?"bg-primary":""},a.myscope.isCurrentVsTab=function(b){return a.myscope.currentVsTab.vsId==b?"bg-primary":""},a.debug=function(){},a.myscope.back=function(){a.$emit("dataReload"),a.myscope.showVS=null,B=null,C=0,a.markers={},A&&(A.setStyle(p()),A=null),a.leafletData.getMap().then(function(a){a.fitBounds(MAP_DEFAULT_BOUND[z])})},a.$on("leafletDirectiveMap.geojsonMouseover",r),a.$on("leafletDirectiveMap.geojsonMouseout",s),a.$on("leafletDirectiveMap.geojsonClick",t),a.myscope.registerDialog=function(a){g.open({templateUrl:"views/closereg.html",controller:"registerCloseController",size:"md",resolve:{data:function(){return{county:z,type:a}}}})},a.myscope.reportDialog=function(){var b=g.open({templateUrl:"views/report.html",controller:"ReportCtrl",size:"md",resolve:{data:function(){return{county:z,vsId:a.myscope.currentVsTab.vsId,vsName:a.myscope.currentVsTab.vsName}}}});b.result.then(function(){})},a.defaults={zoomControlPosition:"bottomright",scrollWheelZoom:!1,minZoom:MAP_MIN_ZOOM[z]},a.maxbounds={northEast:MAP_DEFAULT_BOUND[z][0],southWest:MAP_DEFAULT_BOUND[z][1]},a.leafletData.getMap().then(function(a){a.fitBounds(MAP_DEFAULT_BOUND[z])}),y(!0),a.$on("dataReload",function(){var b=(new Date).getTime();b-E>MAP_RELOAD_TIME&&(E=b,a.$emit("missionDataReload"),y(!1))}),angular.extend(a,{layers:{baselayers:{googleRoadmap:{name:"Google Streets",layerType:"ROADMAP",type:"google"}}}})}]);var MY_HTTP_DELAY=200,MY_HTTP_RETRY=3e3,MY_REQUERY_TIME=1e4,MY_DEFAULT_MAX_COUNT=1e3;angular.module("projectVApp").service("voteInfoService",["$q","$http",function(a,b){function c(c,d){function e(a){u[c]=0,f.resolve(t[c][a])}var f=a.defer();if(u[c]+=1,u[c]>1)var g=setInterval(function(){t[c][d]&&(clearInterval(g),e(d))},MY_HTTP_DELAY);else if(t[c][d])e(d);else{var h=function(){var a="json/"+c+"/"+d+".json";b.get(a).success(function(a){t[c][d]=a,e(d)}).error(function(){setTimeout(function(){h()},MY_HTTP_RETRY)})};h()}return f.promise}this.localReg={"TPE-4":"http://goo.gl/MURskc","TPQ-1":"http://goo.gl/forms/Z70b1CHQpu","TPQ-6":"http://goo.gl/GBVDd7"},this.MAP_BUFFER_TIME=10,Parse.initialize("QDCw1Ntq4E9PmPpcuwKbO2H0B1H0y77Vj1ScO9Zx","6jaJvf46pYub6Ej9IjhhIXNtZjTqRY0P4IqAJFhH");var d=Parse.Object.extend("citizen"),e=Parse.Object.extend("poll"),f=(Parse.Object.extend("volunteer"),Parse.Object.extend("resource"),Parse.Object.extend("report")),g=Parse.Object.extend("bossHp"),h=Parse.Object.extend("afterStation"),i=Parse.Object.extend("afterCount"),j=Parse.Object.extend("afterRegister"),k={},l={},m={},n={},o=this;this.supplementItem={pen:[5,"筆"],board:[5,"連署板"],water:[5,"水"],chair:[2,"椅子"],desk:[1,"桌子"],umbrella:[1,"水果攤用大傘"]},this.volCount=5;var p=0,q=0,r=0,s={},t={votestat:{},villageVotestat:{},twCountyVillage:{}},u={votestat:0,villageVotestat:0,twCountyVillage:0};this.getAllVoteStatData=function(a){return c("votestat",a)},this.getAllVillageVotestatData=function(a){return c("villageVotestat",a)},this.getCountyVillage=function(a){return c("twCountyVillage",a)},this.getParsedQuery=function(b,c,d,e,f){function g(a){s[a].count=0,h.resolve(s[a].results)}var h=a.defer(),i=c+"_"+b+"_"+d+"_"+e+"_"+f;s[i]||(s[i]={count:0}),s[i].count+=1;var j=(new Date).getTime();if(f||(f=1e3),s[i].time&&j-s[i].time<MY_REQUERY_TIME)g(i);else if(s[i].count>1)var k=setInterval(function(){s[i].results&&(clearInterval(k),g(i))},MY_HTTP_DELAY);else{var l=function(){b.descending("createdAt"),b.equalTo(d,e),b.limit(f),b.find({success:function(a){s[i]={time:j,results:a,count:0},h.resolve(a)},error:function(){setTimeout(function(){l()},MY_HTTP_RETRY)}})};l()}return h.promise},this.getCitizenData=function(b){function c(a){q=0,f.resolve(k[a])}function d(a){var b=a.get("resourceBody")?angular.copy(a.get("resourceBody")).reverse():[],c=a.get("volunteerBody")?angular.copy(a.get("volunteerBody")).reverse():[];return{county:a.get("county"),poll:a.get("poll"),resource:a.get("resource"),volunteer:a.get("volunteer"),resourceBody:b,volunteerBody:c}}var f=a.defer();if(q+=1,k[b])c(b);else if(q>1)var g=setInterval(function(){k[b]&&(clearInterval(g),c(b))},MY_HTTP_DELAY);else{var h=new Parse.Query(e);o.getParsedQuery(h,"pollParse","county",b).then(function(a){for(var e=[],f=0;f<a.length;f++)e.push(d(a[f]));k[b]=e,c(b)})}return f.promise},this.getAllVillageSum=function(b){function c(a){p=0,d.resolve(l[a])}var d=a.defer();if(p+=1,l[b])c(b);else if(p>1)var e=setInterval(function(){l[b]&&(clearInterval(e),c(b))},3*MY_HTTP_DELAY);else a.all([o.getAllVoteStatData(b),o.getCitizenData(b),o.getAllVillageVotestatData(b)]).then(function(a){var d=a[0],e=a[1],f=a[2],g={},h={};for(var i in d)for(var j=0;j<d[i].length;j++)h[d[i][j].id]=d[i][j].power;for(var j=0;j<e.length;j++){var k=e[j],m=k.poll;g[m]=0;var n=k.volunteer>h[m]*o.volCount?1:k.volunteer/(h[m]*o.volCount),p=0,q=0;for(var r in o.supplementItem){var s=k.resource[r]?k.resource[r]:0;p+=s>h[m]*o.supplementItem[r][0]?1:s/(h[m]*o.supplementItem[r][0]),q+=1}g[m]=(n+p/q)/2}var t={};for(var u in f){t[u]={};for(var v in f[u]){for(var w=f[u][v],x=0,j=0;j<w.length;j++)g[w[j]]&&(x+=g[w[j]]);t[u][v]=0==w.length?null:x/w.length}}l[b]=t,c(b)});return d.promise},this.getAllVoteStatInfo=function(b){function c(a){r=0,d.resolve(m[a])}var d=a.defer();if(r+=1,m[b])c(b);else if(r>1)var e=setInterval(function(){m[b]&&(clearInterval(e),c(b))},3*MY_HTTP_DELAY);else a.all([o.getCitizenData(b),o.getAllVoteStatData(b)]).then(function(a){var d=a[0],e=a[1],f={};for(var g in e)for(var h=0;h<e[g].length;h++){var i=e[g][h];f[i.id]={vlist:[],vCount:0,volunteer:0,slist:[],sItemCount:{},sItemSum:0,sTotalSum:0,supplement:0,address:i.address,vweight:i.power}}for(var h=0;h<d.length;h++){var j=d[h],k=j.poll,l=j.resource;f[k].vCount=j.volunteer,f[k].vlist=j.volunteerBody,f[k].slist=j.resourceBody;for(var n in o.supplementItem)f[k].sItemCount[n]||(f[k].sItemCount[n]=0),l[n]&&parseInt(l[n])>0&&(f[k].sItemCount[n]=parseInt(l[n]))}for(var p in f){var q=f[p].vweight*o.volCount;f[p].volunteer=f[p].vCount>q?1:f[p].vCount/q;var r=0,s=0;for(var n in o.supplementItem){var t=o.supplementItem[n][0]*f[p].vweight;r+=t,f[p].sItemCount[n]||(f[p].sItemCount[n]=0),s+=f[p].sItemCount[n]>=t?t:f[p].sItemCount[n]}f[p].sItemSum=s,f[p].sTotalSum=r,f[p].supplement=s>r?1:s/r}m[b]=f,c(b)});return d.promise},this.getStaticVillageData=function(c){var d=a.defer(),e=0,f=0,g=0;return a.all([o.getCountyVillage(c),o.getAllVillageSum(c)]).then(function(a){function h(a,b,h){f+=1,setTimeout(function(){g+=1;var f=0;j[b]&&(null==j[b][h]||j[b][h])&&(f=j[b][h]),d.notify({villageArea:k[a],villageSum:f,loadingStatus:g/e,county:c}),g==e&&d.resolve({complete:!0,loadingStatus:g/e,county:c})},o.MAP_BUFFER_TIME*f)}var i=a[0],j=a[1];n[c]=n[c]?n[c]:{};var k=n[c];angular.forEach(i,function(a,d){angular.forEach(a,function(a){e+=1;var f=c+"_"+d+"_"+a;if(k[f])h(f,d,a);else{var g="json/twVillage2010/"+c+"/"+d+"/"+a+".json";b.get(g).success(function(b){k[f]=b,h(f,d,a)}).error(function(){k[f]={},h(f,d,a)})}})})}),d.promise},this.saveCitizen=function(a,b){var c=new d;c.save(a).then(function(){b()})},this.saveReport=function(a,b){var c=new f;c.save(a).then(function(){b()})},this.queryCitizen=function(){var b=a.defer();return b.resolve(!1),b.promise},this.getBossHp=function(b){var c=a.defer(),d=new Parse.Query(g);return o.getParsedQuery(d,"hpQuery","county",b,1).then(function(a){var b=a[0];c.resolve({total:b.get("total"),receive:b.get("receive")})}),c.promise},this.getAfterStatData=function(b){var c=a.defer(),d=new Parse.Query(h);return o.getParsedQuery(d,"afterStatQuery","county",b).then(function(a){for(var b=[],d={},e=0;e<a.length;e++){var f=a[e];f.get("show")!==!1&&(b.push(f.id),d[f.id]={name:f.get("name"),address:f.get("address"),comment:f.get("comment"),latlng:f.get("latlng")})}c.resolve({statList:b,statInfo:d})}),c.promise},this.getAfterStatVillageData=function(c){var d=a.defer(),e=0,f=0,g=0,h=new Parse.Query(i);return a.all([o.getCountyVillage(c),o.getParsedQuery(h,"afterCountQuery","county",c)]).then(function(a){function h(a,b,h){f+=1,setTimeout(function(){g+=1;var f={count:0,maxCount:MY_DEFAULT_MAX_COUNT};k[b]&&k[b][h]?f=k[b][h]:(k[b]||(k[b]={}),k[b][h]=f),d.notify({villageArea:l[a],villageSum:f,loadingStatus:g/e,county:c}),g==e&&d.resolve({complete:!0,loadingStatus:g/e,county:c,afterCount:k})},o.MAP_BUFFER_TIME*f)}var i=a[0],j=a[1],k={};n[c]=n[c]?n[c]:{};for(var l=n[c],m=0;m<j.length;m++){var p=j[m],q=p.get("town"),r=p.get("village");k[q]||(k[q]={}),k[q][r]={count:p.get("count"),maxCount:parseInt(.25*p.get("maxCount"))}}angular.forEach(i,function(a,d){angular.forEach(a,function(a){e+=1;var f=c+"_"+d+"_"+a;if(l[f])h(f,d,a);else{var g="json/twVillage2010/"+c+"/"+d+"/"+a+".json";b.get(g).success(function(b){l[f]=b,h(f,d,a)}).error(function(){l[f]={},h(f,d,a)})}})})}),d.promise},this.resetDynamics=function(a){k[a]&&delete k[a],l[a]&&delete l[a],m[a]&&delete m[a]},this.saveAfterReg=function(a,b){var c=new j;c.save(a).then(function(){b()})}}]);var MY_HTTP_DELAY=200,MY_HTTP_RETRY=3e3,MY_REQUERY_TIME=1e4,MY_DEFAULT_MAX_COUNT=5e3;angular.module("projectVApp").service("addparserservice",["$q","$http",function(){this.MAP_BUFFER_TIME=10,Parse.initialize("QDCw1Ntq4E9PmPpcuwKbO2H0B1H0y77Vj1ScO9Zx","6jaJvf46pYub6Ej9IjhhIXNtZjTqRY0P4IqAJFhH");var a=Parse.Object.extend("afterCount"),b={"TPE-4":[["內湖區大湖里",4260],["內湖區五分里",7918],["內湖區內湖里",4841],["內湖區內溝里",3702],["內湖區石潭里",2249],["內湖區安泰里",4215],["內湖區安湖里",5951],["內湖區行善里",5318],["內湖區西安里",5427],["內湖區西康里",7323],["內湖區西湖里",6329],["內湖區秀湖里",5059],["內湖區明湖里",3810],["內湖區東湖里",6562],["內湖區金湖里",6860],["內湖區金瑞里",5416],["內湖區金龍里",4535],["內湖區南湖里",3779],["內湖區康寧里",6450],["內湖區清白里",6325],["內湖區港都里",4273],["內湖區港富里",7560],["內湖區港華里",6981],["內湖區港墘里",4761],["內湖區湖元里",4380],["內湖區湖興里",6698],["內湖區湖濱里",6583],["內湖區紫星里",6514],["內湖區紫陽里",6368],["內湖區紫雲里",4675],["內湖區週美里",5267],["內湖區瑞光里",3811],["內湖區瑞陽里",6483],["內湖區葫洲里",5217],["內湖區碧山里",5644],["內湖區樂康里",6569],["內湖區麗山里",4489],["內湖區寶湖里",5381],["內湖區蘆洲里",975],["南港區九如里",5079],["南港區三重里",3539],["南港區中南里",3231],["南港區中研里",7292],["南港區仁福里",4502],["南港區玉成里",4039],["南港區合成里",5764],["南港區成福里",5359],["南港區百福里",4226],["南港區西新里",3893],["南港區東明里",4212],["南港區東新里",5496],["南港區南港里",5123],["南港區重陽里",3575],["南港區新光里",3110],["南港區新富里",3243],["南港區萬福里",3473],["南港區聯成里",4244],["南港區鴻福里",3832],["南港區舊莊里",7337]],"TPQ-6":[["板橋區中正里",3860],["板橋區仁翠里",2613],["板橋區介壽里",2597],["板橋區公館里",3252],["板橋區文化里",2618],["板橋區文聖里",3251],["板橋區文翠里",3477],["板橋區文德里",2604],["板橋區民安里",1739],["板橋區民權里",2363],["板橋區永安里",2825],["板橋區光華里",2352],["板橋區光榮里",2207],["板橋區吉翠里",3184],["板橋區江翠里",4155],["板橋區百壽里",2065],["板橋區自立里",2428],["板橋區自強里",4566],["板橋區宏翠里",4036],["板橋區赤松里",620],["板橋區幸福里",3419],["板橋區忠誠里",3371],["板橋區忠翠里",7821],["板橋區明翠里",4264],["板橋區松柏里",1805],["板橋區松翠里",3039],["板橋區社後里",7290],["板橋區金華里",3424],["板橋區青翠里",2571],["板橋區建國里",3134],["板橋區柏翠里",3319],["板橋區流芳里",1217],["板橋區香社里",3649],["板橋區香雅里",2284],["板橋區挹秀里",1468],["板橋區留侯里",1325],["板橋區純翠里",4534],["板橋區國光里",3256],["板橋區埤墘里",3406],["板橋區莊敬里",3233],["板橋區莒光里",2561],["板橋區嵐翠里",2188],["板橋區朝陽里",3008],["板橋區港尾里",2270],["板橋區港嘴里",5225],["板橋區港德里",4130],["板橋區湳興里",4536],["板橋區華江里",5071],["板橋區華翠里",3071],["板橋區陽明里",2495],["板橋區黃石里",981],["板橋區新民里",3637],["板橋區新生里",3769],["板橋區新埔里",1949],["板橋區新海里",3169],["板橋區新翠里",6587],["板橋區新興里",2717],["板橋區溪頭里",5045],["板橋區滿翠里",2654],["板橋區漢生里",3747],["板橋區福翠里",1292],["板橋區德翠里",5532],["板橋區龍翠里",4304],["板橋區聯翠里",3166],["板橋區懷翠里",5149]],"TPQ-1":[["八里區下罟里",1159],["八里區大崁里",2075],["八里區米倉里",2554],["八里區長坑里",1299],["八里區荖阡里",1461],["八里區訊塘里",3227],["八里區埤頭里",2884],["八里區頂罟里",1523],["八里區龍源里",5344],["八里區舊城里",5306],["三芝區八賢里",336],["三芝區古庄里",906],["三芝區店子里",603],["三芝區後厝里",1802],["三芝區茂長里",528],["三芝區埔坪里",5514],["三芝區埔頭里",4027],["三芝區圓山里",535],["三芝區新庄里",818],["三芝區福德里",692],["三芝區橫山里",535],["三芝區興華里",1118],["三芝區錫板里",722],["石門區山溪里",836],["石門區石門里",1427],["石門區尖鹿里",1447],["石門區老梅里",2035],["石門區茂林里",622],["石門區草里里",887],["石門區乾華里",359],["石門區富基里",1266],["石門區德茂里",1061],["林口區下福里",1024],["林口區中湖里",2713],["林口區仁愛里",4560],["林口區太平里",1202],["林口區西林里",5960],["林口區東林里",3511],["林口區東勢里",4702],["林口區林口里",3911],["林口區南勢里",8289],["林口區頂福里",966],["林口區湖北里",1269],["林口區湖南里",9269],["林口區菁湖里",3568],["林口區瑞平里",657],["林口區嘉寶里",784],["林口區麗林里",5738],["林口區麗園里",3237],["泰山區大科里",800],["泰山區山腳里",5341],["泰山區全興里",6298],["泰山區同榮里",3369],["泰山區同興里",2905],["泰山區明志里",3158],["泰山區泰友里",1913],["泰山區貴子里",3214],["泰山區貴和里",4080],["泰山區貴賢里",3078],["泰山區新明里",2803],["泰山區楓樹里",3312],["泰山區義仁里",5567],["泰山區義學里",3532],["泰山區福泰里",2375],["泰山區福興里",2902],["泰山區黎明里",2733],["淡水區八勢里",3901],["淡水區大庄里",3799],["淡水區中和里",555],["淡水區中興里",3594],["淡水區屯山里",959],["淡水區文化里",1565],["淡水區水源里",1988],["淡水區水碓里",4679],["淡水區北投里",4901],["淡水區北新里",2133],["淡水區正德里",3289],["淡水區民生里",5603],["淡水區民安里",710],["淡水區民權里",3282],["淡水區永吉里",811],["淡水區竹圍里",5178],["淡水區沙崙里",2753],["淡水區協元里",1369],["淡水區坪頂里",1202],["淡水區幸福里",3614],["淡水區忠山里",806],["淡水區忠寮里",1051],["淡水區油車里",4449],["淡水區長庚里",1381],["淡水區竿蓁里",6798],["淡水區崁頂里",2524],["淡水區草東里",732],["淡水區埤島里",1027],["淡水區清文里",1068],["淡水區新民里",3787],["淡水區新生里",949],["淡水區新春里",5126],["淡水區新義里",3529],["淡水區新興里",4850],["淡水區義山里",2233],["淡水區福德里",5423],["淡水區賢孝里",1368],["淡水區鄧公里",4943],["淡水區學府里",3370],["淡水區樹興里",1005],["淡水區興仁里",1407],["淡水區蕃薯里",862]]},c=[];this.run=function(){for(var a in b)for(var d=0;d<b[a].length;d++)c.push({town:b[a][d][0].substr(0,3),village:b[a][d][0].substr(3,6),count:0,maxCount:b[a][d][1],county:a});console.log("length",c.length)},this.saveAfterCountParse=function(b,c){if(b[0]){console.log("send",JSON.stringify(b[0]));var d=new a;d.save(b[0]).then(function(){c(b.splice(1),c)})}}}]),angular.module("projectVApp").controller("MissionCtrl",["$scope","Countdown","FINALDATE_DISTRICTS","$interval","$route","$routeParams","voteInfoService","FeedService","$anchorScroll",function(a,b,c,d,e,f,g,h,i){i();var j=f.county,k="effect:",l="area:",m="type:",n=/「(.+)」.*by(.*)。/i,o={"TPE-4":{name:"祭止兀",img:"images/head-tsai.png",black_img:"images/head-tsai-ko.png",finaldate:c.TPE4},"TPQ-6":{name:"林鴻池",img:"images/head-lin.png",black_img:"images/head-lin-black.png",finaldate:c.TPQ6},"TPQ-1":{name:"WEGO昇",img:"images/head-wu.png",black_img:"images/head-wu-black.png",finaldate:c.TPQ1}};a.miscope={},a.miscope.county=j,a.miscope.vCount=0,a.miscope.vTotal=0,a.miscope.sCount=0,a.miscope.sTotal=0,a.miscope.boss=o[j],a.miscope.newCitizen=[],a.miscope.mapLoadingComplete=!1,a.miscope.bossHP={},a.miscope.bossHP.receive=1,a.miscope.bossHP.total=1,a.miscope.regURL=g.localReg[j],g.getBossHp(j).then(function(b){a.miscope.bossHP=b}),h.parseFeed("http://appyv.tumblr.com/rss").then(function(b){var c=b.data.responseData.feed.entries,d=c[Math.floor(Math.random()*c.length)],e=d.content.match(n),f=new DOMParser,g=f.parseFromString(d.content,"text/html");if(e){a.speech=e[1],a.citizen=e[2];var h=g.querySelector("img");h&&(a.citizenAvatar={"background-image":"url("+h.src+")"})}}),h.parseFeed("http://appytw.tumblr.com/rss").then(function(b){var c=b.data.responseData.feed.entries,d=[],e=[],f=[],g=6;angular.forEach(c,function(a){angular.forEach(a.categories,function(b){0===b.indexOf(l)?a.area=b.substr(l.length):0===b.indexOf(k)?a.effect=b.substr(k.length).replace("-"," "):0===b.indexOf(m)&&(a.type=b.substr(m.length))}),a.area||(a.area="all"),("all"===a.area||a.area===j)&&d.push(a)}),angular.forEach(d,function(a){"boss"===a.type?e.length<g&&e.push(a):a.type&&"v"!==a.type&&f.length<g&&f.push(a)}),a.bossFeeds=angular.copy(e),a.citizenFeeds=angular.copy(f)}),a.miscope.gotoMap=function(){$("html, body").animate({scrollTop:$("#mission_map_container").offset().top},500)},a.miscope.hp1=function(){var b=1-a.miscope.bossHP.receive/a.miscope.bossHP.total;return b>=0?b:0},a.miscope.hp2=function(){var b=1-(a.miscope.bossHP.receive-a.miscope.bossHP.total)/a.miscope.hp2Total();return b},a.miscope.hp2Total=function(){return parseInt(.25*a.miscope.bossHP.total)},g.getBossHp(j),a.miscope.bossframe=function(){return a.miscope.hp1()>0?"mission_frame_boss":"mission_frame_boss_black"},a.time=b.getTime(new Date(a.miscope.boss.finaldate),new Date),d(function(){a.time=b.getTime(new Date(a.miscope.boss.finaldate),new Date)},1e3)}]),angular.module("projectVApp").controller("registerDialogController",["$scope","$timeout","$modalInstance","Facebook","voteInfoService","data","$analytics",function(a,b,c,d,e,f,g){function h(b){a.$apply("connected"==b.status?function(){a.me()}:function(){a.logged=!1,n=!1,a.fbname="",a.editState=0,a.unregster=0})}function i(b){if(b&&b.id){a.content.userid=b.id,a.content.name=b.name,a.fbname=b.name,a.content.phone="",a.content.email="",a.regscope.fbshare=!0,a.regscope.fbmessage=m,a.content.areaOrder=[a.regscope.nonAreaSelect[0],a.regscope.nonAreaSelect[1],a.regscope.nonAreaSelect[2]],a.content.supplement={};for(var c in o)a.content.supplement[c]=0;e.queryCitizen(b.id,f.type).then(function(b){a.unregster=b?1:2})}else a.me()}function j(a){return/^\+?(0|[1-9]\d*)$/.test(a)}function k(){var b={fid:parseInt(a.content.userid),volunteer:"volunteer"==a.content.type,poll:f.vsId,name:a.content.name,mobile:a.content.phone,email:a.content.email,county:f.county,resource:a.content.supplement};a.regscope.nonArea&&(b.areaOrder=a.content.areaOrder.join(",")),e.saveCitizen(b,function(){g.eventTrack("join",{areaOrder:b.areaOrder,volunteer:b.volunteer,county:b.county,resource:b.resource}),a.editState=3})}function l(){var b=a.regscope.fbmessage;d.api("/me/feed","post",{message:b,link:"http://1129vday.tw/"},function(a){!a||a.error||g.eventTrack("postToFacebook")})}a.regscope={};var m="我已經報名「割闌尾V計劃」志工了！\n11/29 割闌尾計畫於三個選區的投票所外不妨害投票行為的地點，設立「罷免連署示範攤位」，並邀請所有公民V有物資出物資、有力出力，擔任一天志工或贊助當日擺攤一日物資所需。\n#1129一日志工 ＃我們一起讓罷免復活 ＃割闌尾V計劃";a.logged=!1,a.fbname="",a.unregster=0,a.editState=0,a.facebookReady=!1,a.$watch(function(){return d.isReady()},function(b){b&&(a.facebookReady=!0)});var n=!1;a.intentLogin=function(){a.login()},a.login=function(){d.login(function(a){h(a)},{scope:"publish_stream,publish_actions"})},a.me=function(){d.api("/me",function(b){a.$apply(function(){b.error||(i(b),a.logged=!0,n=!0)})})},a.logout=function(){d.logout(function(){a.$apply(function(){a.logged=!1,n=!1,a.fbname="",a.unregster=0,a.editState=0,a.regscope.errors=""})})},a.$on("Facebook:statusChange",function(a,b){h(b)}),d.getLoginStatus(function(a){h(a)}),a.regscope.selectItems=e.supplementItem;var o=a.regscope.selectItems;a.regscope.nonAreaSelect=["台北市","新北市","台南市","高雄市"],a.regscope.type=f.type,a.regscope.nonArea=f.nonArea,a.regscope.supCount=f.supCount,a.regscope.supWeight=f.supWeight,a.regscope.errors="",a.regscope.newuser=!0,a.regscope.fbshare=!0,a.regscope.fbmessage=m,a.content={type:f.type,votestat:f.vsName,vsid:f.vsId,userid:"",name:"",phone:"",email:"",areaOrder:[a.regscope.nonAreaSelect[0],a.regscope.nonAreaSelect[1],a.regscope.nonAreaSelect[2]],supplement:{}};for(var p in o)a.content.supplement[p]=0;var q={name:"暱稱",phone:"手機",email:"E-Mail"},r=function(){var b=a.content.supplement;for(var c in o)if(!j(b[c]))return[!1,"物資數量填寫錯誤"];for(var c in o)if(b[c]>0)return[!0,""];return[!1,"請填選您要提供的物資"]};a.send=function(){var b=[];if(a.content.register.$invalid){var d=a.content.register;for(var e in q)d[e].$error.required&&b.push("請填寫您的"+q[e]),d[e].$error.email&&b.push("您的"+q[e]+"格式不符")}var f=r();"supplement"!=a.content.type||f[0]||b.push(f[1]),0==b.length?0==a.editState?a.editState=1:1==a.editState?(a.editState=2,1==a.regscope.fbshare&&l(),k()):3==a.editState&&c.close(!0):a.regscope.errors=b.join("，")},a.cancel=function(){c.dismiss("cancel")}}]),angular.module("projectVApp").controller("registerCloseController",["$scope","$timeout","$modalInstance","Facebook","voteInfoService","data","$analytics",function(a,b,c,d,e,f){a.regscope={},a.regscope.type=f.type,a.cancel=function(){c.dismiss("cancel")}}]),angular.module("projectVApp").factory("FeedService",["$http",function(a){return{parseFeed:function(b){return a.jsonp("//ajax.googleapis.com/ajax/services/feed/load?v=1.0&num=50&callback=JSON_CALLBACK&q="+encodeURIComponent(b+"?"+(new Date).getTime()))}}}]),angular.module("projectVApp").controller("NewsCtrl",["$scope","FeedService","Countdown","FINALDATE","$interval",function(a,b,c,d,e){var f={street:"掃街活動",speech:"宣講活動",music:"音樂活動",multiple:"綜合活動",hide:"隱藏活動",boss:"魔王消息"};b.parseFeed("http://appytw.tumblr.com/rss").then(function(b){var c=[];angular.forEach(b.data.responseData.feed.entries,function(a){c.length>=10||(c.push(a),angular.forEach(a.categories,function(b){if(0===b.indexOf("type:")){var c=b.substr("type:".length);a.type=c,a.tag=f[c]}}),a.tag||(a.tag="最新消息",a.type="multiple"))}),a.feeds=c}),a.time=c.getTime(new Date(d),new Date),e(function(){a.time=c.getTime(new Date(d),new Date)},1e3)}]),angular.module("projectVApp").service("Countdown",function(){return{getTime:function(a,b){var c=a-b,d=parseInt(c/1e3/60/60),e=parseInt(d/24);d-=24*e;var f=parseInt(c/6e4-60*d-24*e*60),g=parseInt(c/1e3%60),h=parseInt(5*g/3);return{hpRatio:c/1e3/2592e3,days:e,hours:d,minutes:f,seconds:g,ratio:h,ms:c}}}}),angular.module("projectVApp").constant("FINALDATE","2014/11/29").constant("FINALDATE_DISTRICTS",{TPE4:"2014/12/15",TPQ6:"2014/12/27",TPQ1:"2014/12/27"}),angular.module("projectVApp").controller("MrouteCtrl",["$scope","$routeParams","$location",function(a,b,c){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"];var d=b.county;c.path("/mission/"+d)}]),angular.module("projectVApp").controller("ReportCtrl",["$scope","$timeout","$modalInstance","Facebook","voteInfoService","data",function(a,b,c,d,e,f){a.errortype=["投開票所在地圖上標錯位置","投開票所名稱有誤","投開票所地址有誤","投開票所的所屬里有誤","此投開票所不存在","其他"],a.hassave=!1,a.report={county:f.county,poll:f.vsId,type:a.errortype[0],content:""},a.save=function(){a.hassave=!0,e.saveReport(a.report,function(){setTimeout(function(){c.close(!0)},1e3)})},a.cancel=function(){c.dismiss("cancel")}}]),angular.module("projectVApp").controller("FaqCtrl",["$scope","$analytics",function(a,b){b.eventTrack("faq"),a.items=[{q:"因為不知道志工要作什麼，所以不太敢答應",a:"我們 V 計畫一日志工，主要是希望您可以在投完票後，能夠去您所在的投開票所，或是你所想要佔領的投開票所，同我們一起當「割友」現場收取連署書！"},{q:"網站要求張貼到 facebook 的權限，但沒有說明會貼什麼，請問會張貼哪些資訊到 Facebook？",a:"我們在臉書上僅會貼出「你已報名當志工！」等宣傳網站資訊，希望可以分享給您臉書社群的好朋友一起共襄盛舉！而割闌尾團隊有法律團隊把關著，個資資料僅會作於聯繫您使用，絕對不會將個資外洩！！"},{q:"我提供的資料有需要修改的地方，要在哪邊修改呢？",a:'若您有任何需要修改的地方，請寄信到 <a href="mailto:appy.service@gmail.com">appy.service@gmail.com</a>'},{q:"物資表裡面有個項目我不懂，什麼是水果攤用大傘（俗稱五百萬傘）阿？",a:'讓我們一起看笨版長知識 XDDDD <a target="_blank" href="https://www.ptt.cc/bbs/StupidClown/M.1401775870.A.305.html">[無言] 500萬的傘</a>'},{q:"資料填錯了要怎麼辦呀？ 後悔想要換投開所怎麼辦？",a:'如果有資料想要更改或是想要更換投開票所，請洽詢 <a href="mailto:appy.volunteer@gmail.com">appy.volunteer@gmail.com</a> 會有專人跟你聯絡唷！'},{q:"為什麼有些投開所的比例怪怪的啊？有些五個人有些甚至到65個人？",a:"通常會有很多人的需求的投開票所，通常因為在同一個地址內（例如：學校）有很多個投開票所（例如：很多教室）。因此為了因應兩倍甚至到五倍的選舉人會前往投票，攤位人員的需求也會隨之提升囉！"},{q:"為什麼有些里顯示為沒有投開票所，但是點選旁邊的里時，又會有投開票所在該裡出現呢？",a:'我們投開票所資料是根據中選會官方的資料所標示。其中有些會是A里的投開票所在B里，或是有些里沒有設置投開票所。如有問題也麻煩請回報 <a href="mailto:appy.service@gmail.com">appy.service@gmail.com</a> 會有專人跟你聯絡唷！'},{q:"為什麼我的瀏覽器顯示會有問題怪怪的呀？",a:"身為專業的工程師在此呼籲，請多用 Chrome及 Firefox！ (地方的工程師只有一個肝.... 沒有空再做其他瀏覽器相容啦XDDDD) "},{q:"報名後怎麼毫無反應只是報名完成？為什麼我報名完後沒有收到信，隔天再報名的時候才收到阿 (而且還是在垃圾郵件信夾？) ",a:"關於出現毫無反應的結果請檢查一下您的垃圾郵件夾，誰知道現在的黨工.... 另外如果報名第二次才成功，可能是系統忙碌中，沒有收到你的請求喔！請多見諒了！"},{q:"我要怎麼看到自己報名的投開票所阿？",a:"我們認為現在網站的體驗，要再弄這個功能比較沒有感受到使用者體驗 (其實是懶得做XDDD) 不過....嘿嘿.... There's one more thing coming!!! 敬請期待!!"},{q:"我的問題沒有列在 FAQ 裡面",a:'請寄信至 <a href="mailto:appy.service@gmail.com">appy.service@gmail.com</a>，我們將會盡快回覆您'},{q:"我發現網站有 bug!",a:'請到 <a target="_blank" href="https://github.com/g0v/projectV/issues">github</a> 回報網站錯誤'}]
}]),angular.module("projectVApp").filter("htmlToPlaintext",function(){return function(a){return a=a||"",String(a).replace(/<[^>]+>/gm,"").replace(/&[\d\w]+;/,"").replace("more","").replace("!--","")}});var DEFAULT_COUNTY="TPE-4",MAP_RELOAD_TIME=1e4,MAP_DEFAULT_BOUND={"TPE-4":[{lat:25.1151655,lng:121.6659156},{lat:25.0122295,lng:121.5521896}],"TPQ-1":[{lat:25.301133,lng:121.6195265},{lat:25.0287778,lng:121.2826487}],"TPQ-6":[{lat:25.0398178,lng:121.4895901},{lat:25.0034634,lng:121.4451953}]},MAP_MIN_ZOOM={"TPE-4":13,"TPQ-1":11,"TPQ-6":14};angular.module("projectVApp").controller("AftermapCtrl",["$scope","$route","$routeParams","$http","$q","$filter","$modal","$window","$location","leafletData","voteInfoService",function(a,b,c,d,e,f,g,h,i,j,k){function l(){m(C)}function m(b){var c=b[0];return a.myscope.mapLoadingStatus=.2+(C.length-b.length)/C.length*.8,c?void(a.geojson?a.leafletData.getGeoJSON().then(function(a){a.addData(c),setTimeout(function(){m(b.slice(1))},k.MAP_BUFFER_TIME)}):(a.geojson={data:c,style:n,resetStyleOnMouseout:!1},setTimeout(function(){m(b.slice(1))},k.MAP_BUFFER_TIME))):(a.myscope.mapLoadingStatus=1,$(".myLoading").fadeOut("slow",function(){$(".myLoading").remove(),"TPE-4"!=y&&$("#mroute-TPE-4").css({visibility:"visible"}),"TPQ-6"!=y&&$("#mroute-TPQ-6").css({visibility:"visible"}),"TPQ-1"!=y&&$("#mroute-TPQ-1").css({visibility:"visible"})}),void(a.myscope.mapLoadingComplete=!0))}function n(a){return{opacity:1,weight:2,color:"black",dashArray:"6",fillOpacity:.5,fillColor:a.properties.mycolor,className:"county transparent"}}function o(){return{weight:2,color:"black",dashArray:"6"}}function p(){return{weight:6,color:"yellow",dashArray:"0"}}function q(a,b){var c=b.target;c!=z&&(c.setStyle(G),c.bringToFront(),z&&z.bringToFront())}function r(a,b){var c=b.target;c!=z&&(c.setStyle(H),c.bringToFront(),z&&z.bringToFront())}function s(a,b,c){var d=c.target.feature.properties.town,e=c.target.feature.properties.village,f=c.target;t(d,e,f),setTimeout(function(){$("#map_sidebar_village").scrollTo("#count_"+d+"_"+e)},0)}function t(b,c,d){a.myscope.setVillTab(b,c),z&&z.setStyle(o()),d.setStyle(p()),d.bringToFront(),z=d}function u(){a.markers={};var b=[];angular.forEach(a.myscope.afterStat,function(c){b.push({vsid:c,vspos:b.length,vsobj:{lat:a.myscope.afterStatInfo[c].latlng.latitude,lng:a.myscope.afterStatInfo[c].latlng.longitude}})}),b.length>0&&w(b)}function v(b){a.myscope.showVS=!0,a.myscope.currentVsTab.vsId=b}function w(b){var c={};A=null,angular.forEach(b,function(a){c[a.vsid]={draggable:!1,lat:a.vsobj.lat,lng:a.vsobj.lng,icon:E[2].x,myicons:E[2],mypos:a.vspos,myid:a.vsid}}),angular.extend(a,{markers:c}),a.$on("leafletDirectiveMarker.click",function(b,c){a.myscope.setCurrentMarkerClick(c.markerName,!0)}),a.$on("leafletDirectiveMarker.mouseover",function(b,c){var d=a.markers[c.markerName];d.icon=d.myicons.d}),a.$on("leafletDirectiveMarker.mouseout",function(b,c){var d=(c.markerName,a.markers[c.markerName]);d.icon=d!=A?d.myicons.x:d.myicons.c})}function x(){k.resetDynamics(y),k.getAfterStatVillageData(y).then(function(b){a.myscope.afterCount=b.afterCount,a.myscope.townList=Object.keys(a.myscope.afterCount),a.myscope.setTownTab(a.myscope.townList[0]),(b.county=y)&&l()},function(){},function(b){(b.county=y)&&(a.myscope.mapLoadingStatus=.2*b.loadingStatus,jQuery.isEmptyObject(b.villageArea)||(b.villageArea.features[0].properties.mycolor=F(b.villageSum.count/b.villageSum.maxCount),C.push(b.villageArea)))}),e.all([k.getAfterStatData(y)]).then(function(b){a.myscope.afterStat=b[0].statList,a.myscope.afterStatInfo=b[0].statInfo,u()})}a.parseInt=parseInt,a.myscope={},a.myscope.mapLoadingComplete=!1,a.myscope.mapLoadingStatus=!1;var y=c.county,z=null,A=null,B=0,C=[],D=(new Date).getTime();a.myscope.county=y,a.myscope.showVS=null,a.myscope.currentVsTab={},a.myscope.currentTownTab="",a.myscope.currentVillTab="",a.myscope.afterStat=[],a.myscope.afterStatInfo={},a.myscope.afterCount={},a.myscope.townList=[],a.miscope.regURL=k.localReg[y],a.leafletData=j;var E=function(){var a=[60,100],b=[30,10],c=[a[0]/2,a[1]],d=[b[0]/2,b[1]/2],e=["1","2","3"],f=["x","c","d"],g={};return angular.forEach(e,function(e){g[e]={},angular.forEach(f,function(f){g[e][f]={iconSize:a,iconAnchor:c,iconUrl:"images/map"+f+e+".svg",shadowSize:b,shadowAnchor:d,shadowUrl:"images/map_icon_shadow.svg"}})}),g}();y in MAP_DEFAULT_BOUND||(y=DEFAULT_COUNTY);var F=function(a){return null==a?"#333333":a>=1?"#770000":a>.75?"#882222":a>.5?"#994444":a>.25?"#aa6666":a>0?"#bb8888":"#bbbbbb"};a.myscope.getVoteStatImg=function(){return a.myscope.showVS?2:1};var G={weight:6,color:"white"},H={weight:2,color:"black"};a.myscope.setCurrentAreaClick=function(b,c){a.leafletData.getGeoJSON().then(function(a){var d=a.getLayers();angular.forEach(d,function(a){var d=a.feature.properties.town,e=a.feature.properties.village;b==d&&c==e&&t(b,c,a)})})},a.myscope.setCurrentMarkerClick=function(b,c){var d=a.markers[b];B=d.mypos,v(b),A&&(A.icon=A.myicons.x),d.icon=d.myicons.c,A=d,c&&a.leafletData.getMap().then(function(a){a.getZoom()<16?a.setView({lat:d.lat,lng:d.lng},16):a.setView({lat:d.lat,lng:d.lng})})},a.myscope.setTownTab=function(b){a.myscope.currentTownTab=b,a.myscope.currentVillTab="",z&&(z.setStyle(o()),z=null)},a.myscope.setVillTab=function(b,c){a.myscope.currentTownTab=b,a.myscope.currentVillTab=c},a.myscope.isCurrentTownTab=function(b){return a.myscope.currentTownTab==b?"bg-primary":""},a.myscope.isCurrentVillTab=function(b,c){return a.myscope.currentTownTab==b&&a.myscope.currentVillTab==c?"map_sidebar_villlclick":""},a.debug=function(){},a.myscope.back=function(){a.myscope.showVS=null,A&&(A.icon=A.myicons.x),A=null,B=0,z&&(z.setStyle(o()),z=null),a.leafletData.getMap().then(function(a){a.fitBounds(MAP_DEFAULT_BOUND[y])})},a.$on("leafletDirectiveMap.geojsonMouseover",q),a.$on("leafletDirectiveMap.geojsonMouseout",r),a.$on("leafletDirectiveMap.geojsonClick",s),a.myscope.registerDialog=function(){var b=g.open({templateUrl:"views/afterreg.html",controller:"AfterregCtrl",size:"md",resolve:{data:function(){return{county:y,nonArea:!1,vsId:a.myscope.currentVsTab.vsId,vsName:a.myscope.afterStatInfo[a.myscope.currentVsTab.vsId].name}}}});b.result.then(function(){i.path("/")})},a.myscope.reportDialog=function(){var b=g.open({templateUrl:"views/report.html",controller:"ReportCtrl",size:"md",resolve:{data:function(){return{county:y,vsId:a.myscope.currentVsTab.vsId,vsName:""}}}});b.result.then(function(){})},a.defaults={zoomControlPosition:"bottomright",scrollWheelZoom:!1,minZoom:MAP_MIN_ZOOM[y]},a.maxbounds={},a.leafletData.getMap().then(function(a){a.fitBounds(MAP_DEFAULT_BOUND[y])}),x(!0),a.$on("dataReload",function(){var b=(new Date).getTime();b-D>MAP_RELOAD_TIME&&(D=b,a.$emit("missionDataReload"),x(!1))}),angular.extend(a,{layers:{baselayers:{googleRoadmap:{name:"Google Streets",layerType:"ROADMAP",type:"google"}}}})}]),angular.module("projectVApp").controller("AfterregCtrl",["$scope","$timeout","$modalInstance","Facebook","voteInfoService","data","$analytics",function(a,b,c,d,e,f,g){function h(b){a.$apply("connected"==b.status?function(){a.me()}:function(){a.logged=!1,n=!1,a.fbname="",a.editState=0,a.unregster=0})}function i(b){b&&b.id?(a.content.userid=b.id,a.content.name=b.name,a.fbname=b.name,a.content.phone="",a.content.email="",a.content.volOuter=!1,a.content.volInner=!1,a.regscope.fbshare=!0,a.regscope.fbmessage=m,a.content.areaOrder=[a.regscope.nonAreaSelect[0],a.regscope.nonAreaSelect[1],a.regscope.nonAreaSelect[2]]):a.me()}function j(a){return/^\+?(0|[1-9]\d*)$/.test(a)}function k(){var b={fid:parseInt(a.content.userid),poll:f.vsId,name:a.content.name,mobile:a.content.phone,email:a.content.email,county:f.county};a.regscope.nonArea&&(b.areaOrder=a.content.areaOrder.join(","))}function l(){var b=a.regscope.fbmessage;d.api("/me/feed","post",{message:b,link:"http://1129vday.tw/"},function(a){!a||a.error||g.eventTrack("postToFacebook")})}a.regscope={};var m="我已經報名「割闌尾V計劃」志工了！\n11/29 割闌尾計畫於三個選區的投票所外不妨害投票行為的地點，設立「罷免連署示範攤位」，並邀請所有公民V有物資出物資、有力出力，擔任一天志工或贊助當日擺攤一日物資所需。\n#1129一日志工 ＃我們一起讓罷免復活 ＃割闌尾V計劃";a.logged=!1,a.fbname="",a.unregster=0,a.editState=0,a.facebookReady=!1,a.$watch(function(){return d.isReady()},function(b){b&&(a.facebookReady=!0)});var n=!1;a.intentLogin=function(){a.login()},a.login=function(){d.login(function(a){h(a)},{scope:"publish_stream,publish_actions"})},a.me=function(){d.api("/me",function(b){a.$apply(function(){b.error||(i(b),a.logged=!0,n=!0)})})},a.logout=function(){d.logout(function(){a.$apply(function(){a.logged=!1,n=!1,a.fbname="",a.unregster=0,a.editState=0,a.regscope.errors=""})})},a.$on("Facebook:statusChange",function(a,b){h(b)}),d.getLoginStatus(function(a){h(a)}),a.regscope.selectItems=e.supplementItem;var o=a.regscope.selectItems;a.regscope.nonAreaSelect=["台北市","新北市","台中市","台南市","高雄市"],a.regscope.nonArea=f.nonArea,a.regscope.errors="",a.regscope.newuser=!0,a.regscope.fbshare=!0,a.regscope.fbmessage=m,a.content={votestat:f.vsName,vsid:f.vsId,userid:"",name:"",phone:"",email:"",areaOrder:[a.regscope.nonAreaSelect[0],a.regscope.nonAreaSelect[1],a.regscope.nonAreaSelect[2]]};var p={name:"暱稱",phone:"手機",email:"E-Mail"},q=function(){var b=a.content.supplement;for(var c in o)if(!j(b[c]))return[!1,"物資數量填寫錯誤"];for(var c in o)if(b[c]>0)return[!0,""];return[!1,"請填選您要提供的物資"]};a.send=function(){var b=[];if(a.content.register.$invalid){var d=a.content.register;for(var e in p)d[e].$error.required&&b.push("請填寫您的"+p[e]),d[e].$error.email&&b.push("您的"+p[e]+"格式不符")}var f=q();"supplement"!=a.content.type||f[0]||b.push(f[1]),0==b.length?0==a.editState?a.editState=1:1==a.editState?(a.editState=2,1==a.regscope.fbshare&&l(),k()):3==a.editState&&c.close(!0):a.regscope.errors=b.join("，")},a.cancel=function(){c.dismiss("cancel")}}]);